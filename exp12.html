<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Lab Experiments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Prism CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    
    <style>
        .token.keyword { color: #569CD6; }
        .token.string { color: #CE9178; }
        .token.number { color: #B5CEA8; }
        .token.function { color: #DCDCAA; }
        .language-sql { color: #D4D4D4; }
        pre[class*="language-"] {
            background: #1E1E1E !important;
            margin: 0;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex flex-col md:flex-row min-h-screen">
        <div id="sidebar" class="hidden md:block w-full md:w-72 bg-gradient-to-b from-gray-800 to-gray-900 text-white p-6 shadow-xl">
            <!-- Sidebar content will be generated by JavaScript -->
        </div>

        <div class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-8">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Experiment 11: Triggers in PL/SQL</h1>
                    <div class="flex flex-col md:flex-row items-start md:items-center text-sm text-gray-500">
                        <span class="mb-2 md:mb-0 md:mr-4">üìÖ Date: May 5, 2025</span>
                        <span>‚è±Ô∏è Duration: 2 hours</span>
                    </div>
                </div>

                <!-- Theory Section -->
                <section class="mb-8 bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Theory</h2>
                    <div class="space-y-4">
                        <p class="text-gray-600">
                            Triggers are special PL/SQL blocks that automatically execute when specific database events occur. They can be used for:
                        </p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <h3 class="text-blue-600 font-semibold mb-2">Timing</h3>
                                <ul class="list-disc list-inside text-gray-600">
                                    <li>BEFORE triggers</li>
                                    <li>AFTER triggers</li>
                                    <li>INSTEAD OF triggers</li>
                                </ul>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <h3 class="text-green-600 font-semibold mb-2">Level</h3>
                                <ul class="list-disc list-inside text-gray-600">
                                    <li>Row-level triggers</li>
                                    <li>Statement-level triggers</li>
                                </ul>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <h3 class="text-purple-600 font-semibold mb-2">Events</h3>
                                <ul class="list-disc list-inside text-gray-600">
                                    <li>INSERT</li>
                                    <li>UPDATE</li>
                                    <li>DELETE</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Syntax Section -->
                <section class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Syntax Reference</h2>
                    
                    <div class="bg-gray-800 text-white p-4 rounded-lg mb-4 relative">
                        <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded absolute top-4 right-4 copy-button">Copy</button>
                        <pre><code class="language-sql">
-- Basic Trigger Syntax
CREATE [OR REPLACE] TRIGGER trigger_name
{BEFORE | AFTER | INSTEAD OF} {INSERT | UPDATE | DELETE}
    [OF column1, column2, ...]
ON table_name
[REFERENCING OLD AS old NEW AS new]
[FOR EACH ROW]
[WHEN (condition)]
DECLARE
    -- Variable declarations
BEGIN
    -- Trigger body
END;
/

-- Row-Level Trigger Example
CREATE OR REPLACE TRIGGER row_trigger
BEFORE INSERT ON employees
FOR EACH ROW
BEGIN
    -- Trigger logic here
END;
/

-- Statement-Level Trigger Example
CREATE OR REPLACE TRIGGER stmt_trigger
AFTER DELETE ON employees
BEGIN
    -- Trigger logic here
END;
/</code></pre>
                    </div>
                </section>

                <!-- Database Setup -->
                <section class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Database Setup</h2>
                    <div class="bg-gray-800 text-white p-4 rounded-lg mb-4 relative">
                        <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded absolute top-4 right-4 copy-button">Copy</button>
                        <pre><code class="language-sql">
-- Create tables for trigger demonstration
CREATE TABLE employees (
    emp_id NUMBER PRIMARY KEY,
    name VARCHAR2(50),
    salary NUMBER,
    department VARCHAR2(50)
);

CREATE TABLE salary_history (
    emp_id NUMBER,
    old_salary NUMBER,
    new_salary NUMBER,
    change_date DATE,
    change_type VARCHAR2(20)
);

CREATE TABLE dept_summary (
    department VARCHAR2(50) PRIMARY KEY,
    total_employees NUMBER,
    total_salary NUMBER
);

-- Create view for demonstration
CREATE VIEW emp_dept_view AS
    SELECT department, COUNT(*) as emp_count, SUM(salary) as total_salary
    FROM employees
    GROUP BY department;

-- Insert sample data
INSERT INTO employees VALUES (1, 'John Doe', 50000, 'IT');
INSERT INTO employees VALUES (2, 'Jane Smith', 60000, 'HR');
INSERT INTO employees VALUES (3, 'Bob Wilson', 55000, 'IT');
INSERT INTO employees VALUES (4, 'Alice Brown', 62000, 'HR');
COMMIT;</code></pre>
                    </div>
                </section>

                <!-- Implementation Examples -->
                <section class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Implementation Examples</h2>
                    
                    <!-- Example 1: BEFORE and AFTER Triggers -->
                    <div class="mb-6">
                        <h3 class="text-xl text-blue-600 font-semibold mb-3">Example 1: Salary Validation and Logging Triggers</h3>
                        <div class="bg-gray-800 text-white p-4 rounded-lg mb-4 relative">
                            <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded absolute top-4 right-4 copy-button">Copy</button>
                            <pre><code class="language-sql">
-- BEFORE Trigger for salary validation
CREATE OR REPLACE TRIGGER validate_salary
BEFORE INSERT OR UPDATE OF salary ON employees
FOR EACH ROW
BEGIN
    -- Minimum salary check
    IF :NEW.salary < 30000 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Salary cannot be less than 30000');
    END IF;
    
    -- Maximum raise check on updates
    IF UPDATING AND :NEW.salary > :OLD.salary * 1.5 THEN
        RAISE_APPLICATION_ERROR(-20002, 'Salary increase cannot exceed 50%');
    END IF;
END;
/

-- AFTER Trigger for salary history logging
CREATE OR REPLACE TRIGGER log_salary_change
AFTER INSERT OR UPDATE OF salary OR DELETE ON employees
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        INSERT INTO salary_history VALUES(
            :NEW.emp_id, NULL, :NEW.salary, SYSDATE, 'INSERT'
        );
    ELSIF UPDATING THEN
        INSERT INTO salary_history VALUES(
            :NEW.emp_id, :OLD.salary, :NEW.salary, SYSDATE, 'UPDATE'
        );
    ELSIF DELETING THEN
        INSERT INTO salary_history VALUES(
            :OLD.emp_id, :OLD.salary, NULL, SYSDATE, 'DELETE'
        );
    END IF;
END;
/</code></pre>
                        </div>
                    </div>

                    <!-- Example 2: Statement-Level Trigger -->
                    <div class="mb-6">
                        <h3 class="text-xl text-green-600 font-semibold mb-3">Example 2: Department Summary Maintenance</h3>
                        <div class="bg-gray-800 text-white p-4 rounded-lg mb-4 relative">
                            <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded absolute top-4 right-4 copy-button">Copy</button>
                            <pre><code class="language-sql">
CREATE OR REPLACE TRIGGER update_dept_summary
AFTER INSERT OR UPDATE OF salary, department OR DELETE ON employees
BEGIN
    -- Refresh department summary
    DELETE FROM dept_summary;
    
    INSERT INTO dept_summary
    SELECT department, COUNT(*), SUM(salary)
    FROM employees
    GROUP BY department;
    
    -- Log the update
    DBMS_OUTPUT.PUT_LINE('Department summary updated at: ' || TO_CHAR(SYSDATE, 'HH24:MI:SS'));
END;
/</code></pre>
                        </div>
                    </div>

                    <!-- Example 3: INSTEAD OF Trigger -->
                    <div class="mb-6">
                        <h3 class="text-xl text-purple-600 font-semibold mb-3">Example 3: View Modification Handler</h3>
                        <div class="bg-gray-800 text-white p-4 rounded-lg mb-4 relative">
                            <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded absolute top-4 right-4 copy-button">Copy</button>
                            <pre><code class="language-sql">
CREATE OR REPLACE TRIGGER emp_view_insert
INSTEAD OF INSERT ON emp_dept_view
DECLARE
    v_avg_salary NUMBER;
BEGIN
    -- Calculate average salary for department
    SELECT AVG(salary)
    INTO v_avg_salary
    FROM employees
    WHERE department = :NEW.department;
    
    -- Insert with calculated average if no salary specified
    INSERT INTO employees VALUES(
        (SELECT NVL(MAX(emp_id), 0) + 1 FROM employees),
        :NEW.department || '_Employee',
        NVL(v_avg_salary, 50000),
        :NEW.department
    );
END;
/</code></pre>
                        </div>
                    </div>

                    <!-- Test Cases -->
                    <div class="mb-6">
                        <h3 class="text-xl text-orange-600 font-semibold mb-3">Test Cases</h3>
                        <div class="bg-gray-800 text-white p-4 rounded-lg mb-4 relative">
                            <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded absolute top-4 right-4 copy-button">Copy</button>
                            <pre><code class="language-sql">
-- Test BEFORE and AFTER triggers
UPDATE employees SET salary = 65000 WHERE emp_id = 1;
UPDATE employees SET salary = 20000 WHERE emp_id = 2; -- Should fail

-- Test Statement trigger
SELECT * FROM dept_summary;

-- Test INSTEAD OF trigger
INSERT INTO emp_dept_view (department) VALUES ('Finance');</code></pre>
                        </div>
                    </div>

                    <!-- Output Results -->
                    <section class="mb-8">
                        <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-4">Test Results</h2>
                        <div class="space-y-6">
                            <!-- Test Case 1 Output -->
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h3 class="text-blue-600 font-semibold mb-2">1. Salary Update Results</h3>
                                <pre class="bg-gray-50 p-4 rounded text-sm overflow-x-auto">
-- Successful update
UPDATE employees SET salary = 65000 WHERE emp_id = 1;
1 row updated.

-- Failed update (triggers error)
UPDATE employees SET salary = 20000 WHERE emp_id = 2;
ERROR at line 1:
ORA-20001: Salary cannot be less than 30000

-- Check salary_history table
SELECT * FROM salary_history WHERE emp_id = 1;

EMP_ID  OLD_SALARY  NEW_SALARY  CHANGE_DATE          CHANGE_TYPE
----------------------------------------------------------------
1       50000       65000       05-MAY-2025 14:30:22  UPDATE</pre>
                            </div>

                            <!-- Test Case 2 Output -->
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h3 class="text-blue-600 font-semibold mb-2">2. Department Summary Results</h3>
                                <pre class="bg-gray-50 p-4 rounded text-sm overflow-x-auto">
SELECT * FROM dept_summary ORDER BY department;

DEPARTMENT  TOTAL_EMPLOYEES  TOTAL_SALARY
-------------------------------------------
HR          2               122000
IT          2               120000

Department summary updated at: 14:30:22</pre>
                            </div>

                            <!-- Test Case 3 Output -->
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h3 class="text-blue-600 font-semibold mb-2">3. View Insertion Results</h3>
                                <pre class="bg-gray-50 p-4 rounded text-sm overflow-x-auto">
-- Insert into view
INSERT INTO emp_dept_view (department) VALUES ('Finance');
1 row inserted.

-- Check employees table
SELECT * FROM employees WHERE department = 'Finance';

EMP_ID  NAME              SALARY   DEPARTMENT
------------------------------------------------
5       Finance_Employee  50000    Finance

-- Check updated department summary
SELECT * FROM dept_summary WHERE department = 'Finance';

DEPARTMENT  TOTAL_EMPLOYEES  TOTAL_SALARY
-------------------------------------------
Finance     1               50000</pre>
                            </div>

                            <!-- Trigger Execution Summary -->
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h3 class="text-blue-800 font-semibold mb-2">Trigger Execution Summary</h3>
                                <ul class="list-disc list-inside text-blue-900 space-y-2">
                                    <li>BEFORE Trigger: Successfully validated salary constraints</li>
                                    <li>AFTER Trigger: Logged all salary changes in history table</li>
                                    <li>Statement Trigger: Maintained accurate department summaries</li>
                                    <li>INSTEAD OF Trigger: Handled view insertions with default values</li>
                                    <li>All triggers maintained data integrity and consistency</li>
                                </ul>
                            </div>
                        </div>
                    </section>
                </section>
            </div>
        </div>
    </div>
    <script src="js/main.js"></script>
</body>
</html>